---
title: "Paper figures"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(reticulate)
#use_python("/home/oma21/miniconda3/envs/enm/bin/python")
use_condaenv('enm')
setwd('../')
```

```{python}
import matplotlib.pyplot as plt
import matplotlib as mpl
import networkx as nx
import numpy as np
import pandas as pd
import plotnine as p9
import pickle 
import os
import re
import itertools as itr
from src.enm import Enm

with open(f'data/interim/pcc_0909/pcc.pickle','rb') as f:
    e_pcc = pickle.load(f)
with open(f'data/interim/yuri_0916/yuri.pickle','rb') as f:
    e_yuri = pickle.load(f)
with open(f'data/interim/huri_0916/huri.pickle','rb') as f:
    e_huri = pickle.load(f)

pcc_df = e_pcc.df
pcc_gc = e_pcc.graph_gc
pcc_gc_pos = (dict(pcc_gc.nodes(data='pos')))
yuri_df = e_yuri.df
huri_df = e_huri.df
```

```{r}
library(tidyverse)
library(cowplot)
library(ggpubr)

pcc_df = py$pcc_df%>%mutate(data='pcc')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'real')%>%bind_rows(
    py$e_pcc$e_list[[1]]$df%>%mutate(data='pcc')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'random')
)%>%mutate(group=fct_relevel(group, c('real','random')))
yuri_df = py$yuri_df%>%mutate(data='yuri')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'real')%>%bind_rows(
    py$e_yuri$e_list[[1]]$df%>%mutate(data='yuri')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'random')
)%>%mutate(group=fct_relevel(group, c('real','random')))
huri_df = py$huri_df%>%mutate(data='huri')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'real')%>%bind_rows(
    py$e_huri$e_list[[1]]$df%>%mutate(data='huri')%>%mutate(sens_norm = sens/nrow(.),eff_norm = eff/nrow(.), group = 'random')
)%>%mutate(group=fct_relevel(group, c('real','random')))
combined_df = bind_rows(pcc_df, yuri_df,huri_df)%>%
    mutate(data= fct_relevel(data, c('pcc','yuri','huri')))
```

```{r}
pcc_deg_eff = pcc_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=eff_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Effectiveness")+
    xlab("Degree")+
    stat_cor(method='pearson', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
pcc_deg_sens = pcc_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=sens_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Sensitivity")+
    xlab("Degree")+
    stat_cor(method='spearman', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
yuri_deg_eff = yuri_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=eff_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Effectiveness")+
    xlab("Degree")+
    stat_cor(method='pearson', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
yuri_deg_sens = yuri_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=sens_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Sensitivity")+
    xlab("Degree")+
    stat_cor(method='spearman', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
huri_deg_eff = huri_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=eff_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Effectiveness")+
    xlab("Degree")+
    stat_cor(method='pearson', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
huri_deg_sens = huri_df %>% #pivot_longer(cols=sens_norm:eff_norm, names_to="prs_data_type", values_to="prs_data_value")%>%
    ggplot(aes(x=deg, y=sens_norm))+
    geom_point()+
    facet_grid(rows = vars(group), scales='free') +
    theme_bw()+
    ylab("Sensitivity")+
    xlab("Degree")+
    stat_cor(method='spearman', cor.coef.name='rho', label.x.npc=0.1) +
    theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(labels = scales::label_scientific(digits=1))
cowplot::plot_grid(pcc_deg_eff, pcc_deg_sens,
                   yuri_deg_eff, yuri_deg_sens,
                   huri_deg_eff, huri_deg_sens,
                   ncol=2)
ggsave('tmp.png',width=10,height=10)

p1 = ggplot(pcc_df, aes(x=deg,y=eff_norm))+
    geom_point(aes(color=cat_))+
    xlab('Degree')+
    ylab('Effectiveness')+
    stat_cor(method='pearson')   +
    guides(color=guide_legend(title="Experiment categories"))+
    theme_bw()
p2 = ggplot(pcc_df, aes(x=deg,y=sens_norm))+
    geom_point(aes(color=cat_))+
    xlab('Degree')+
    ylab('Sensitivity')+
    stat_cor(method='spearman')   +
    guides(color=guide_legend(title="Experiment categories"))+
    theme_bw()+theme(legend.text = element_text(margin = margin(t=5, b = 5, unit = "pt")))
lgn = cowplot::get_legend(p2)
fig3 = plot_grid(p1+theme(legend.position=''),
          p2+theme(legend.position=''),
          lgn, nrow=1, labels=c('A','B',''),rel_widths=c(0.4,0.4,0.2))
ggsave('reports/figures/paper_figures_0916/fig3.png', fig3, width=8,height=6)
```

```{r}
pcc_rewire_df = read_csv('data/interim/pcc_0909/rewire_data.csv')
yuri_rewire_df = read_csv('data/interim/yuri/rewire_data.csv')
huri_rewire_df = read_csv('data/interim/huri/rewire_data.csv')

rewire_df = pcc_rewire_df%>%mutate(data='pcc')%>%bind_rows(
                                                           yuri_rewire_df%>%mutate(data='yuri'))%>%
        bind_rows(huri_rewire_df%>%mutate(data='huri'))
```

```{r}
network_labels  <- c('Costanzo 2016','Yeast PPI','HuRI')
#p3 = ggplot(rewire_df, aes(x=eff_deg_pearson))+
#    stat_density(geom = "line", trim=TRUE)+
##    geom_histogram(binwidth = 0.001)+
#    geom_vline(xintercept=0.9,color='red')+
#    theme_bw()

facet_labels  <- network_labels
names(facet_labels) <- c("pcc",'yuri','huri')

combined_rewire_df <- rewire_df%>%select(data, eff_deg_spearman,sens_deg_spearman)%>%mutate(type = 'random')%>% 
    bind_rows(
    data.frame(sens_deg_spearman= c(cor(pcc_df$deg, pcc_df$sens,method='spearman'),cor(yuri_df$deg,yuri_df$sens,method='spearman'),cor(huri_df$deg,huri_df$sens,method='spearman')), eff_deg_spearman= c(cor(pcc_df$deg, pcc_df$eff,method='spearman'),cor(yuri_df$deg,yuri_df$eff,method='spearman'),cor(huri_df$deg,huri_df$eff,method='spearman')), type='real',data=c('pcc','yuri','huri')))%>%
    mutate(data= fct_relevel(data, c('pcc','yuri','huri')))

p3 = 
    ggplot()+
    facet_grid(cols = vars(data), labeller = labeller(data=facet_labels))+
#    geom_boxplot()+
#    geom_jitter()+
    geom_density(data =combined_rewire_df%>%filter(type!='real'),aes(x=eff_deg_spearman,color=type, y=..scaled..),linetype = "dashed")+
    geom_vline(data =combined_rewire_df%>%filter(type=='real'),aes(xintercept=eff_deg_spearman,color=type))+
    guides(color=guide_legend(title="Data type"),shape=guide_legend(title="Network type"))+
    ylab('Density')+xlab('Effectiveness degree correlation')+
    theme_bw()+
    theme(panel.spacing = unit(2, "lines"))+
    scale_y_continuous(expand = c(0, 0)) 
p4 = 
    ggplot()+
    facet_grid(cols = vars(data), labeller = labeller(data=facet_labels))+
#    geom_boxplot()+
#    geom_jitter()+
    geom_density(data =combined_rewire_df%>%filter(type!='real'),aes(x=sens_deg_spearman,y=..scaled..,color=type),linetype = "dashed")+
    geom_vline(data =combined_rewire_df%>%filter(type=='real'),aes(xintercept=sens_deg_spearman,color=type))+
    guides(color=guide_legend(title="Data type"),shape=guide_legend(title="Network type"))+
    ylab('Density')+xlab('Sensitivity degree correlation')+
    theme_bw()+
    theme(panel.spacing = unit(2, "lines"),legend.position='bottom')+
    scale_color_discrete(labels=c('Rewired networks', 'Real networks'))+
    scale_y_continuous(expand = c(0, 0)) 
lgn34  <- cowplot::get_legend(p4)
plot_grid(
          p3+theme(legend.position=''),
 p4+theme(legend.position=''), lgn34,
 nrow=3, labels=c('A','B','','C','D',''), rel_heights = c(0.45,0.45,0.1))
ggsave('reports/figures/paper_figures_0916/fig2.png',width=7)
```


```{r deletion}
pcc_deletion = read_csv('data/interim/deletion_analysis_0911/pcc_deletion.csv')%>%
    pivot_wider(id_cols=c('range','variable_0'),names_from='variable_1',values_from='value')%>%
    mutate(range = range/max(range), gc_size = gc_size/max(gc_size), group='pcc')
yuri_deletion = read_csv('data/interim/deletion_analysis_0911/yuri_deletion.csv')%>%
    pivot_wider(id_cols=c('range','variable_0'),names_from='variable_1',values_from='value')%>%
    mutate(range = range/max(range), gc_size = gc_size/max(gc_size), group='yuri')
huri_deletion = read_csv('data/interim/deletion_analysis_0911/huri_deletion.csv')%>%
    pivot_wider(id_cols=c('range','variable_0'),names_from='variable_1',values_from='value')%>%
    mutate(range = range/max(range), gc_size = gc_size/max(gc_size), group='huri')

deletion_df  <- bind_rows(pcc_deletion, yuri_deletion, huri_deletion)%>%mutate(group = fct_relevel(group,c('pcc','yuri','huri')))


library(MESS)
auc_data <- deletion_df%>%
    group_by(group, variable_0)%>%
    summarise(auc=MESS::auc(gc_size,range), r = range[min(which(gc_size < 0.05))])%>%
    ungroup()%>%
    mutate(variable_0=fct_reorder(variable_0, auc, min))%>%pivot_wider(-r, names_from=group, values_from=auc)

auc_plot_pcc <- auc_data%>%
    ggplot(aes(x=variable_0,y=pcc))+
    geom_bar(aes(fill=variable_0,alpha = (variable_0  )),stat='identity')+
    theme_bw()+
    ylab("Robustness")+
    xlab("Deletion parameter")+
    scale_alpha_manual(name='Deletion\nparameter', values = c(0.3,0.3,1,0.3,0.3,0.3,1), labels= c(
                                "Degree",
                                "Betweenness",
                                "Effectiveness",
                                "Closeness",
                                "Eigencentrality",
                                "Random",
                                "Sensitivity"), guide = 'legend')+
    labs(fill = "Deletion\nparameter")+
    scale_x_discrete(labels = c(
                                "D",
                                "B",
                                "Eff",
                                "C",
                                "E",
                                "R",
                                "S"))+
    scale_fill_brewer(name = 'Deletion\nparameter', palette = "Set1", guide='legend', labels= c(
                                "Degree",
                                "Betweenness",
                                "Effectiveness",
                                "Closeness",
                                "Eigencentrality",
                                "Random",
                                "Sensitivity"))+
   theme(legend.position='bottom', legend.title=element_text(size=18), legend.text=element_text(size=14),legend.spacing.x = unit(1.0, 'cm'),legend.spacing.y = unit(1.0, 'cm'))
auc_plot_yuri <- auc_data%>%
    ggplot(aes(x=variable_0,y=yuri))+
    geom_bar(aes(fill=variable_0,alpha = (variable_0 == "eff_sorted_deletion" | variable_0 == 'sens_sorted_deletion') ),stat='identity')+
    theme_bw()+
    ylab("Robustness")+
    xlab("Deletion parameter")+
    labs(fill = "Deletion\nparameter")+
    scale_alpha_manual(name = '', values = c(0.3, 1), guide = FALSE)+
    scale_x_discrete(labels = c(
                                "D",
                                "B",
                                "Eff",
                                "C",
                                "E",
                                "R",
                                "S"))+
    scale_fill_brewer(name='', palette = "Set1", labels= c(
                                "Degree",
                                "Betweenness",
                                "Effectiveness",
                                "Closeness",
                                "Eigencentrality",
                                "Random",
                                "Sensitivity"))+
   theme(legend.position='right')
auc_plot_huri<- auc_data%>%
    ggplot(aes(x=variable_0,y=huri, alpha = (variable_0 == "eff_sorted_deletion" | variable_0 == 'sens_sorted_deletion') ))+
    geom_bar(aes(fill=variable_0),stat='identity')+
    theme_bw()+
    scale_alpha_manual(values = c(0.3, 1), guide = FALSE)+
    ylab("Robustness")+
    xlab("Deletion parameter")+
    labs(fill = "Deletion\nparameter")+
    scale_x_discrete(labels = c(
                                "D",
                                "B",
                                "Eff",
                                "C",
                                "E",
                                "R",
                                "S"))+
    scale_fill_brewer(palette = "Set1", labels= c(
                                "Degree",
                                "Betweenness",
                                "Effectiveness",
                                "Closeness",
                                "Eigencentrality",
                                "Random",
                                "Sensitivity"))+
   theme(legend.position='right')
#combined_df %>% group_by(data)%>%summarise(deg_btw = cor(deg, btw),
#                                           deg_eff = cor(deg,eff),
#                                           deg_sens = cor(deg,sens),
#                                           deg_eigen = cor(deg, eigenvec_centr),
#                                           deg_closeness = cor(deg, closeness_centr))
deletion_plot_pcc <-  pcc_deletion%>%   mutate(variable_0 = fct_relevel(variable_0, levels(auc_data$variable_0)))%>%
    ggplot(aes(x=range, y= gc_size, color = variable_0 , alpha = (variable_0 == "eff_sorted_deletion" | variable_0 == 'sens_sorted_deletion') ))+
#    geom_point(size=1)+
        geom_line(size=2)+
#    facet_grid(rows = vars(group), labeller = labeller(group=facet_labels))+
    scale_colour_brewer(palette = "Set1")+ 
    xlab('% Deleted Nodes')+
    ylab('% Giant Component Size')+
    scale_y_continuous(labels = scales::percent)+
    scale_x_continuous(labels = scales::percent)+
    theme_bw()+
    ggtitle('Costanzo 2016')+
    scale_alpha_manual(values = c(0.3, 1), guide = FALSE)+
    theme(legend.position='bottom',panel.border = element_blank(), axis.line = element_line())
deletion_plot_yuri <-  yuri_deletion%>%   mutate(variable_0 = fct_relevel(variable_0, levels(auc_data$variable_0)))%>%
ggplot(aes(x=range, y= gc_size, color = variable_0 ,alpha = (variable_0 == "eff_sorted_deletion" | variable_0 == 'sens_sorted_deletion')  ))+
#    geom_point(size=1)+
        geom_line(size=2)+
#    facet_grid(rows = vars(group), labeller = labeller(group=facet_labels))+
    scale_colour_brewer(palette = "Set1")+ 
    xlab('% Deleted Nodes')+
    ggtitle('Yeast PPI')+
    ylab('% Giant Component Size')+
    scale_y_continuous(labels = scales::percent)+
    scale_x_continuous(labels = scales::percent)+
    scale_alpha_manual(values = c(0.3, 1), guide = FALSE)+
    theme_bw()+
    theme(legend.position='right',panel.border = element_blank(), axis.line = element_line())
deletion_plot_huri <-  huri_deletion%>%   mutate(variable_0 = fct_relevel(variable_0, levels(auc_data$variable_0)))%>%
ggplot(aes(x=range, y= gc_size, color = variable_0 , alpha = (variable_0 == "eff_sorted_deletion" | variable_0 == 'sens_sorted_deletion')  ))+
#    geom_point(size=1)+
        geom_line(size=2)+
#    facet_grid(rows = vars(group), labeller = labeller(group=facet_labels))+
    scale_colour_brewer(palette = "Set1")+ 
    xlab('% Deleted Nodes')+
    ylab('% Giant Component Size')+
    ggtitle('HuRI')+
    scale_y_continuous(labels = scales::percent)+
    scale_x_continuous(labels = scales::percent)+
    scale_alpha_manual(values = c(0.3, 1), guide = FALSE)+
    theme_bw()+
    theme(legend.position='right',panel.border = element_blank(), axis.line = element_line())
deletion_lgn <- cowplot::get_legend(auc_plot_pcc)
pcc_with_inset = ggdraw(deletion_plot_pcc+    theme(legend.position=''))+
  draw_plot(auc_plot_pcc+theme(legend.position=''), .50, .62, .45, .35) +
  draw_plot_label(
    c("A", ""),
    c(0, 0.45),
    c(1, 0.95),
    size = 12
  )
yuri_with_inset = ggdraw(deletion_plot_yuri+    theme(legend.position=''))+
  draw_plot(auc_plot_yuri+theme(legend.position=''), .50, .62, .45, .35) +
  draw_plot_label(
    c("B", ""),
    c(0, 0.45),
    c(1, 0.95),
    size = 12
  )
huri_with_inset = ggdraw(deletion_plot_huri+    theme(legend.position=''))+
  draw_plot(auc_plot_huri+theme(legend.position=''), .50, .62, .45, .35) +
  draw_plot_label(
    c("C", ""),
    c(0, 0.45),
    c(1, 0.95),
    size = 12
  )
plot_grid(pcc_with_inset, yuri_with_inset, huri_with_inset, ncol=3)%>%plot_grid(deletion_lgn,nrow=2, rel_heights=c(0.9,.1))
ggsave('reports/figures/paper_figures_0916/fig4.png',width=12)


plot_grid(deletion_plot_pcc+    theme(legend.position='')
, auc_plot_pcc+    theme(legend.position='')
,deletion_lgn, nrow=1, rel_widths =c(0.4, 0.5,.1), labels=c('A','B'))

```

# Sensor connectivity and neighbor degree
```{r}
sensor_connectivity_df <- read_csv('data/interim/sensor_connectivity_0915/sensor_connectivity_df.csv')%>%
    mutate(data= fct_relevel(data, c('pcc','yuri','huri')))

#library(ggridges)

#sensor_connectivity_df %>%
#    filter(type=='random')%>%
#    ggplot(aes(x=ratio,y=data))+
##    facet_grid(rows=vars(data))+
##    geom_histogram(bins=50)
#    geom_density_ridges()
#ggsave('tmp.png',width=12)

#p3 = 
sensor_connectivity_plot <- 
    ggplot()+
    geom_boxplot(data=sensor_connectivity_df%>%filter(type=='random'),
                 aes(x=data,y=ratio,color=type))+
#    geom_jitter()+
    geom_point(data=sensor_connectivity_df%>%filter(type=='real'),
            aes(x=data,y=ratio,color=type, group=data))+
               #position=position_jitter(), aes(shape=data))+
    scale_color_discrete(labels=c('Random sampled set', 'Sensors'))+
    scale_x_discrete(labels=network_labels)+
  guides(color=guide_legend(title="Data type"),shape=guide_legend(title="Network type"))+
    xlab('Network type')+ylab('Ratio of between group edges\nto outgroup edges')+
    theme_bw()
neighbor_degree_plot <- combined_df%>%
    ggplot(aes(x=sens_norm,y=neighbor_degree))+
    facet_grid(cols=vars(data),labeller = labeller(data=facet_labels))+
    geom_point()+
    theme_bw()+
    ylab('Average neighbor degree')+
    xlab('Sensitivity')
plot_grid(neighbor_degree_plot, sensor_connectivity_plot, nrow=2 , labels=c('A','B'))
ggsave('reports/figures/paper_figures_0916/fig5.png')

```

```{r}
convert_networkx_to_igraph <- 			# 
    function
(
 	nx_object,
    df
)
{
    nx =  reticulate::import("networkx")
    ig = igraph::graph.adjacency(nx$adjacency_matrix(nx_object), mode = 'undirected')
    #ig = igraph::set_vertex_attr(ig , name =  'orf_name', value  = (df$orf_name))
    ig = igraph::set_vertex_attr(ig , name =  'name', value  = (df$orf_name))
    #igraph::set_vertex_attr(ig, "pos", nx_object$nodes('pos'))
    ig
}
```


