
---
title: "PRS dendrogram clusters"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(reticulate)
#use_python("/home/oma21/miniconda3/envs/enm/bin/python")
use_condaenv('enm')
setwd('../')
#source('enm/R/plot_density_prs.R')
source('enm/R/get.subclusters.dendrogram.R')
library(RColorBrewer)
col =brewer.pal(n=8,name='Set1')
sensor_colors = col[1:4]
effector_colors = col[5:8]
```

# Read data
Read data in python, from pickle file saved earlier.
```{python}
import matplotlib.pyplot as plt
import matplotlib as mpl
import networkx as nx
import numpy as np
import pandas as pd
import plotnine as p9
import pickle 
import os
import re
import itertools as itr
from enm.enm import Enm
from enm.utils import *
import scipy.cluster.hierarchy as sch

with open(f'data/interim/pcc_021521_withclustering//pcc_10.pickle','rb') as f:
    e_pcc = pickle.load(f)
pcc_df = e_pcc.df
pcc_gc = e_pcc.graph_gc
pcc_gc_pos = (dict(pcc_gc.nodes(data='pos')))

sensors_pcc = e_pcc.sensors_df#e_pcc.df.loc[e_pcc.df.sens>np.quantile(e_pcc.df.sens,0.99)]
effector_pcc = e_pcc.effectors_df
sensor_sub_pcc = get_subnetwork(e_pcc.graph_gc, sensors_pcc.orf_name.values)
effector_sub_pcc = get_subnetwork(e_pcc.graph_gc, effector_pcc.orf_name.values)
effector_order = effector_pcc.groupby('go_term').eff.median().sort_values().index.tolist()
sensor_order = sensors_pcc.groupby('go_term').sens.median().sort_values().index.tolist()
effector_colors_dict = dict(zip(effector_order,r.effector_colors))
sensor_colors_dict = dict(zip(sensor_order,r.sensor_colors))
#sensor_colors_dict['none']=sensor_colors_dict[None]
#del sensor_colors_dict[None]
```

Use scipy distance calculation and pass the square form of the distance matrix to R.
This is done because R's `dist` function is significantly slower than scipy.

```{python}
prs_mat = e_pcc.prs_mat
quantile_threshold =  0.95
method = 'ward'
metric = 'seuclidean'
q99 = np.quantile(prs_mat, quantile_threshold)
prs_mat_cl = copy.deepcopy(prs_mat)
prs_mat_cl[prs_mat_cl > q99] = q99
prs_mat_cl_orig = prs_mat_cl
# , optimal_ordering=True)
#row_linkage_cl = sch.linkage(sch.distance.pdist(prs_mat_cl), method=method)
# ,optimal_ordering=True)
#col_linkage_cl = sch.linkage(sch.distance.pdist(prs_mat_cl.T), method=method)

row_dist_orig = sch.distance.pdist((prs_mat),metric = metric)
col_dist_orig = sch.distance.pdist((prs_mat.T),metric = metric)
row_dist_orig_sqr = sch.distance.squareform(row_dist_orig)
col_dist_orig_sqr = sch.distance.squareform(col_dist_orig)

row_dist = sch.distance.pdist(prs_mat_cl,metric = metric)
col_dist = sch.distance.pdist(prs_mat_cl.T,metric = metric)

row_dist_sqr = sch.distance.squareform(row_dist)
col_dist_sqr = sch.distance.squareform(col_dist)

```
# Plot heatmap
Using the clustering with `seuclidian` distance and `ward` linkage, plot the heatmap with row and column colors are the GO term annotations found from effector and sensor analysis

```{r}
library(tidyverse)
library(ComplexHeatmap)
cluster_method = 'ward.D2'
dist_row = as.dist(py$row_dist_sqr)
hclust_row = hclust(dist_row, cluster_method)
dist_col = as.dist(py$col_dist_sqr)
hclust_col = hclust(dist_col, cluster_method)

go_color_map = unlist(append(py$effector_colors_dict,py$sensor_colors_dict))
go_color_map['none'] = 'white'
clrs = go_color_map# map(py$eff_sens_go_list, ~ifelse(is.null(.x), 'none',.x))%>%unlist()

rowColors = rowAnnotation(rowColors=py$e_pcc$df%>%left_join(py$effector_pcc)%>%select(go_term)%>%pull%>%map(~ifelse(is.na(.x), 'none',.x))%>%unlist(),
                          col=list(rowColors = go_color_map ),
                          #width=unit(100,'mm'),
                          simple_anno_size=unit(3,'cm'),
                          show_annotation_name=FALSE,
                          show_legend=FALSE)
colColors = columnAnnotation(colColors=py$e_pcc$df%>%left_join(py$sensors_pcc)%>%select(go_term)%>%pull%>%map(~ifelse(is.null(.x), 'none',
                                                                                                                      ifelse(is.nan(.x),'none',.x)))%>%unlist(),
                          col=list(colColors = go_color_map ),
                          simple_anno_size=unit(3,'cm'),
                          #annotation_height=unit(20,'mm'),
                          show_annotation_name=FALSE,
                          show_legend=FALSE)
rowAnnot = HeatmapAnnotation(Effectiveness=anno_lines(rowSums(py$prs_mat)),
                            which='row',
                            name='Effectiveness', 
                            gp = gpar(col='blue'),
                            annotation_name_side = 'top',
                            annotation_name_rot= 0,
                            border=FALSE,
                          show_legend=FALSE
)
colAnnot = HeatmapAnnotation(Sensitivity=anno_lines(colSums(py$prs_mat)), 
                             which='col', 
                             name='Sensitivity',
                            gp = gpar(col='blue'),
                            annotation_name_side = 'left',
                            annotation_name_rot=0,
                            border=FALSE,
                          show_legend=FALSE
)
pdf('tmp_heatmap.pdf')
Heatmap(py$prs_mat_cl, 
        cluster_rows = as.dendrogram(hclust_row),
        cluster_columns=as.dendrogram(hclust_col),
        col=RColorBrewer::brewer.pal(9,'YlGnBu'),
        row_dend_width = unit(20,'mm'),
        column_dend_height = unit(20,'mm'),
        right_annotation=rowAnnot,
        left_annotation = rowColors,
        bottom_annotation=colAnnot,
        top_annotation=colColors,
        show_heatmap_legend=TRUE
)
dev.off()

```

Use dendrogram clusters to assign effectors and sensors to subclusters.
Use goatools to find enriched GO terms within each subcluster

```{r}
effector_pcc = py$effector_pcc
sensors_pcc = py$sensors_pcc

dend_row  <- as.dendrogram(hclust_row)
dend_col  <- as.dendrogram(hclust_col)
effector_pcc <- get.subclusters.dendrogram(dend_row, effector_pcc)
sensors_pcc <- get.subclusters.dendrogram(dend_col, sensors_pcc)

# Import goatools functions from enm/utils.py
utils <- import('enm.utils')
create_goa = utils$create_goea(gaf = 'data/raw/ontology/sgd.gaf', obo_fname='data/raw/ontology/go-basic.obo', background='data/interim/costanzo_gc_bg.tsv', sgd_info_tab = 'data/raw/ontology/SGD_features.tab')
goea = create_goa[[1]]
geneid2name = create_goa[[2]]
#utils$query_goatools(sensors_pcc,goea,geneid2name)
eff_go_terms <- list()
sens_go_terms <- list()
for(i in 1:4){
    print(i)
    subcluster <- effector_pcc%>%filter(clusters==i)
    query <- utils$query_goatools(subcluster,goea,geneid2name)
    print(head(query))
    eff_go_terms[i] = query[1,4]
}
effector_pcc <- as.character(eff_go_terms)%>%as.data.frame()%>%rownames_to_column()%>%mutate(rowname=as.numeric(rowname))%>%rename(cluster_go_term='.')%>%right_join(effector_pcc,by=c('rowname'='clusters'))%>%rename(clusters=rowname)

for(i in 1:4){
    print(i)
    subcluster <- sensors_pcc%>%filter(clusters==i)
    query <- utils$query_goatools(subcluster,goea,geneid2name)
    print(query)
    sens_go_terms[i] = query[1,4]
}
sensors_pcc <- as.character(sens_go_terms)%>%as.data.frame()%>%rownames_to_column()%>%mutate(rowname=as.numeric(rowname))%>%rename(cluster_go_term='.')%>%right_join(sensors_pcc,by=c('rowname'='clusters'))%>%rename(clusters=rowname)

#py$e_pcc$df%>%left_join(effector_pcc)%>%ggplot(aes(x=deg,y=eff,color=cluster_go_term))+geom_point()+
#    xlim(0,NA)+ylim(0,NA)+theme(legend.position='none')
#ggsave('tmp.png')
#py$e_pcc$df%>%left_join(sensors_pcc)%>%ggplot(aes(x=deg,y=sens,color=cluster_go_term))+geom_point()+
#    xlim(0,NA)+ylim(0,NA)+theme(legend.position='none')
#ggsave('tmp.png')

```

Save Enm object with dendrogram `cluster_go_term` assignments

```{python}
e_pcc.sensors_df = r.sensors_pcc
e_pcc.effectors_df = r.effector_pcc

with open(f"{e_pcc.output_path}/pcc_10_r.pickle",'wb') as f:
    pickle.dump(e_pcc,f, protocol=4)

```

Save subcluster dendrogram plots

```{r}
library(dendextend)
png('reports/figures/dendrogram021721/row_dendrogram_colored.png',width=800,height=800)
dend_row[[2]] %>% 
    set("branches_k_color", k = 4) %>% 
    set("labels", NA) %>%    # change labelsk
    plot(xlab="", sub="")
dev.off()
png('reports/figures/dendrogram021721/col_dendrogram_colored.png',width=800,height=800)
dend_col[[1]] %>% 
    set("branches_k_color", k = 4) %>% 
    set("labels", NA) %>%    # change labelsk
    plot(xlab="", sub="")
dev.off()
```


# Seriation analysis

```{r}
library(seriation)
library(tictoc)

tic()
row_order_seriation <- seriate(dist_row, method = 'OLO_ward')
col_order_seriation <- seriate(dist_col, method = 'OLO_ward')
toc()

pdf('tmp_heatmap.pdf')
Heatmap(py$prs_mat_cl_orig, 
        row_order= get_order(row_order_seriation),
        column_order = get_order(col_order_seriation),
        col=RColorBrewer::brewer.pal(9,'YlGnBu'),
#        row_dend_width = unit(20,'mm'),
#        column_dend_height = unit(20,'mm'),
        right_annotation=rowAnnot,
        left_annotation = rowColors,
        bottom_annotation=colAnnot,
        top_annotation=colColors,
        show_heatmap_legend=TRUE
)
dev.off()

tic()
prs_order = seriate(py$prs_mat_cl_orig, method='BEA_TSP')
toc()
 
pdf('tmp_heatmap.pdf')
Heatmap(py$prs_mat_cl_orig, 
        row_order= get_order(prs_order,1),
        column_order = get_order(prs_order,2),
        col=RColorBrewer::brewer.pal(9,'YlGnBu'),
#        row_dend_width = unit(20,'mm'),
#        column_dend_height = unit(20,'mm'),
        right_annotation=rowAnnot,
        left_annotation = rowColors,
        bottom_annotation=colAnnot,
        top_annotation=colColors,
        show_heatmap_legend=TRUE
)
dev.off()

hclust_col_reordered <- reorder(hclust_col,dist_col)
hclust_row_reordered <- reorder(hclust_row,dist_row)

pdf('tmp_heatmap.pdf',width=6,height=6)
Heatmap((py$prs_mat_cl),
        cluster_rows = as.dendrogram(hclust_row_reordered),
        cluster_columns=as.dendrogram(hclust_col_reordered),
        col=RColorBrewer::brewer.pal(9,'YlGnBu'),
        show_row_dend=FALSE,
        show_column_dend=FALSE,
        row_dend_width = unit(1,'in'),
        column_dend_height = unit(1,'in'),
        right_annotation=rowAnnot,
        left_annotation = rowColors,
        bottom_annotation=colAnnot,
        top_annotation=colColors,
        show_heatmap_legend=TRUE
)
dev.off()
```

